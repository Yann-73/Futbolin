<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFI Control de Ingresos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        h2 {
            color: #3498db;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .counter {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
        .payment-options {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        #submitBtn {
            background-color: #2ecc71;
            color: white;
        }
        #changeLastBtn {
            background-color: #e74c3c;
            color: white;
        }
        #downloadBtn {
            background-color: #3498db;
            color: white;
        }
        .records {
            margin-top: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .totals {
            margin-top: 20px;
            padding: 15px;
            background-color: #eaf7ea;
            border-radius: 5px;
            display: flex;
            justify-content: space-around;
        }
        .total-box {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-width: 120px;
        }
        .total-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .total-value {
            font-size: 18px;
            color: #2c3e50;
        }
        .github-settings {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .github-settings h3 {
            margin-top: 0;
        }
        .github-settings input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .github-settings label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .status-indicator {
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Bienvenido a la Página para Control de Ingresos</h1>
    <h2>Cancha de Futbolín - Costo por Uso Bs. 5</h2>
    
    <div class="form-container">
        <div class="github-settings" id="githubSettings">
            <h3>Configuración de GitHub</h3>
            <div>
                <label for="repoOwner">Propietario del Repositorio:</label>
                <input type="text" id="repoOwner" placeholder="usuario o organización">
            </div>
            <div>
                <label for="repoName">Nombre del Repositorio:</label>
                <input type="text" id="repoName" placeholder="nombre-repositorio">
            </div>
            <div>
                <label for="filePath">Ruta del Archivo (ej: datos/registros.txt):</label>
                <input type="text" id="filePath" placeholder="carpeta/archivo.txt">
            </div>
            <div>
                <label for="accessToken">Token de Acceso Personal:</label>
                <input type="password" id="accessToken" placeholder="ghp_...">
            </div>
            <button id="saveGithubSettings" style="background-color: #6c757d; color: white; width: 100%;">Guardar Configuración</button>
            <div id="githubStatus" class="status-indicator hidden"></div>
        </div>
        
        <div class="counter">Registro #<span id="counter">1</span></div>
        
        <div class="payment-options">
            <h3>Método de Pago:</h3>
			<div style="display: flex; justify-content: center; gap: 90px;">
				<label>
					<input type="checkbox" name="payment" value="Efectivo" id="cash"> Pago en Efectivo
				</label>
				<label>
					<input type="checkbox" name="payment" value="QR" id="qr"> Pago por QR
				</label>
			</div>
        </div>
        
        <div class="buttons">
            <button id="changeLastBtn" disabled>Cambiar Último Registro</button>
            <button id="submitBtn">Enviar</button>
        </div>
        
        <div class="totals">
            <div class="total-box">
                <div class="total-label">Total Efectivo:</div>
                <div class="total-value" id="totalCash">Bs. 0</div>
            </div>
            <div class="total-box">
                <div class="total-label">Total QR:</div>
                <div class="total-value" id="totalQR">Bs. 0</div>
            </div>
            <div class="total-box">
                <div class="total-label">Total General:</div>
                <div class="total-value" id="totalGeneral">Bs. 0</div>
            </div>
        </div>
        
        <button id="downloadBtn" style="width: 100%; margin-top: 10px;">Descargar Registros CSV</button>
        <button id="closeDayBtn" style="width: 100%; margin-top: 10px; background-color: #9b59b6; color: white;">Cerrar Día</button>
    </div>
    
    <div class="records">
        <h3>Registros Guardados:</h3>
        <table id="recordsTable">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>N° Registro</th>
                    <th>Método Pago</th>
                    <th>Monto (Bs.)</th>
                    <th>Operación</th>
                    <th>Total Efectivo</th>
                    <th>Total QR</th>
                </tr>
            </thead>
            <tbody id="recordsBody">
                <!-- Los registros se añadirán aquí -->
            </tbody>
        </table>
    </div>

    <script>
        // Variables globales
        let counter = 1;
        let records = [];
        const costoUso = 5;
        let totalEfectivo = 0;
        let totalQR = 0;
        let currentDate = new Date().toISOString().slice(0, 10); // Fecha actual en formato YYYY-MM-DD
        
        // Variables para GitHub
        let githubConfig = {
            owner: '',
            repo: '',
            filepath: '',
            token: ''
        };
        
        // Elementos del DOM
        const counterElement = document.getElementById('counter');
        const cashCheckbox = document.getElementById('cash');
        const qrCheckbox = document.getElementById('qr');
        const submitBtn = document.getElementById('submitBtn');
        const changeLastBtn = document.getElementById('changeLastBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const closeDayBtn = document.getElementById('closeDayBtn');
        const recordsBody = document.getElementById('recordsBody');
        const totalCashElement = document.getElementById('totalCash');
        const totalQRElement = document.getElementById('totalQR');
        const totalGeneralElement = document.getElementById('totalGeneral');
        
        // Elementos para GitHub
        const saveGithubSettingsBtn = document.getElementById('saveGithubSettings');
        const githubStatusElement = document.getElementById('githubStatus');
        
        // Cargar configuración de GitHub desde localStorage si existe
        function loadGithubConfig() {
            const savedConfig = localStorage.getItem('githubConfig');
            if (savedConfig) {
                githubConfig = JSON.parse(savedConfig);
                document.getElementById('repoOwner').value = githubConfig.owner;
                document.getElementById('repoName').value = githubConfig.repo;
                document.getElementById('filePath').value = githubConfig.filepath;
                document.getElementById('accessToken').value = githubConfig.token;
                
                showGithubStatus('Configuración cargada desde local', true);
            }
        }
        
        // Guardar configuración de GitHub
        saveGithubSettingsBtn.addEventListener('click', function() {
            githubConfig.owner = document.getElementById('repoOwner').value.trim();
            githubConfig.repo = document.getElementById('repoName').value.trim();
            githubConfig.filepath = document.getElementById('filePath').value.trim();
            githubConfig.token = document.getElementById('accessToken').value.trim();
            
            if (!githubConfig.owner || !githubConfig.repo || !githubConfig.filepath || !githubConfig.token) {
                showGithubStatus('Por favor complete todos los campos', false);
                return;
            }
            
            // Guardar en localStorage
            localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
            
            // Validar la configuración haciendo una solicitud para comprobar si el repo existe
            checkGithubAccess();
        });
        
        // Verificar acceso a GitHub
        async function checkGithubAccess() {
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    showGithubStatus('Conexión a GitHub exitosa', true);
                    
                    // Comprobar si el archivo existe, y si no, crearlo
                    await checkAndCreateFile();
                } else {
                    showGithubStatus('Error al conectar con GitHub. Verifique sus credenciales.', false);
                }
            } catch (error) {
                showGithubStatus('Error de conexión: ' + error.message, false);
            }
        }
        
        // Comprobar si el archivo existe y crearlo si no
        async function checkAndCreateFile() {
            try {
                // Verificar si el archivo existe
                let fileExists = false;
                let fileSha = '';
                
                try {
                    const fileResponse = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.filepath}`, {
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (fileResponse.ok) {
                        const fileData = await fileResponse.json();
                        fileExists = true;
                        fileSha = fileData.sha;
                    }
                } catch (fileError) {
                    // El archivo no existe, se creará
                }
                
                if (!fileExists) {
                    // Crear el archivo con un encabezado
                    const headerContent = "Fecha,Hora,N° Registro,Método Pago,Monto (Bs.),Operación,Total Efectivo,Total QR\n";
                    const encodedContent = btoa(unescape(encodeURIComponent(headerContent)));
                    
                    const createResponse = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.filepath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Creación del archivo de registros para ${currentDate}`,
                            content: encodedContent
                        })
                    });
                    
                    if (createResponse.ok) {
                        showGithubStatus('Archivo creado correctamente en GitHub', true);
                    } else {
                        const errorData = await createResponse.json();
                        showGithubStatus(`Error al crear archivo: ${errorData.message}`, false);
                    }
                } else {
                    showGithubStatus('Archivo existente encontrado en GitHub', true);
                }
            } catch (error) {
                showGithubStatus('Error al verificar archivo: ' + error.message, false);
            }
        }
        
        // Función para mostrar mensaje de estado de GitHub
        function showGithubStatus(message, isSuccess) {
            githubStatusElement.textContent = message;
            githubStatusElement.className = isSuccess ? 
                'status-indicator status-success' : 
                'status-indicator status-error';
            githubStatusElement.classList.remove('hidden');
            
            // Ocultar después de 5 segundos
            setTimeout(() => {
                githubStatusElement.classList.add('hidden');
            }, 5000);
        }
        
        // Manejar selección de método de pago (solo uno puede estar seleccionado)
        cashCheckbox.addEventListener('change', function() {
            if (this.checked) {
                qrCheckbox.checked = false;
            }
        });
        
        qrCheckbox.addEventListener('change', function() {
            if (this.checked) {
                cashCheckbox.checked = false;
            }
        });
        
        // Función para enviar un nuevo registro
        submitBtn.addEventListener('click', function() {
            const paymentMethod = cashCheckbox.checked ? 'Efectivo' : (qrCheckbox.checked ? 'QR' : '');
            
            if (!paymentMethod) {
                alert('Por favor seleccione un método de pago');
                return;
            }
            
            const now = new Date();
            const date = now.toLocaleDateString();
            const time = now.toLocaleTimeString();
            const operation = counter * costoUso;
            
            // Actualizar totales
            if (paymentMethod === 'Efectivo') {
                totalEfectivo += costoUso;
            } else {
                totalQR += costoUso;
            }
            
            // Crear el registro
            const record = {
                date,
                time,
                counter,
                paymentMethod,
                monto: costoUso,
                operation,
                totalEfectivo,
                totalQR
            };
            
            // Agregar a los registros
            records.push(record);
            
            // Actualizar la tabla y los totales
            updateRecordsTable();
            updateTotals();
            
            // Incrementar el contador
            counter++;
            counterElement.textContent = counter;
            
            // Limpiar selección
            cashCheckbox.checked = false;
            qrCheckbox.checked = false;
            
            // Habilitar botón de cambiar último registro
            changeLastBtn.disabled = false;
            
            // Guardar en GitHub
            saveToGithub(record);
        });
        
        // Función para cambiar el último registro
        changeLastBtn.addEventListener('click', function() {
            if (records.length === 0) return;
            
            // Confirmar con el usuario
            const confirmChange = confirm('¿Está seguro que desea cambiar el último registro?');
            if (!confirmChange) return;
            
            const lastRecord = records[records.length - 1];
            const newPaymentMethod = cashCheckbox.checked ? 'Efectivo' : (qrCheckbox.checked ? 'QR' : lastRecord.paymentMethod);
            
            if (!cashCheckbox.checked && !qrCheckbox.checked) {
                alert('Por favor seleccione un método de pago para cambiar');
                return;
            }
            
            // Revertir el total anterior
            if (lastRecord.paymentMethod === 'Efectivo') {
                totalEfectivo -= costoUso;
            } else {
                totalQR -= costoUso;
            }
            
            // Aplicar el nuevo método
            if (newPaymentMethod === 'Efectivo') {
                totalEfectivo += costoUso;
            } else {
                totalQR += costoUso;
            }
            
            // Actualizar el último registro
            records[records.length - 1].paymentMethod = newPaymentMethod;
            records[records.length - 1].totalEfectivo = totalEfectivo;
            records[records.length - 1].totalQR = totalQR;
            
            // Actualizar la tabla y los totales
            updateRecordsTable();
            updateTotals();
            
            // Limpiar selección
            cashCheckbox.checked = false;
            qrCheckbox.checked = false;
            
            // Deshabilitar botón de cambiar
            this.disabled = true;
            
            // Actualizar en GitHub
            updateLastRecordInGithub();
        });
        
        // Función para actualizar la tabla de registros
        function updateRecordsTable() {
            recordsBody.innerHTML = '';
            
            records.forEach(record => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.time}</td>
                    <td>${record.counter}</td>
                    <td>${record.paymentMethod}</td>
                    <td>${record.monto}</td>
                    <td>${record.operation}</td>
                    <td>Bs. ${record.totalEfectivo}</td>
                    <td>Bs. ${record.totalQR}</td>
                `;
                
                recordsBody.appendChild(row);
            });
        }
        
        // Función para actualizar los totales mostrados
        function updateTotals() {
            totalCashElement.textContent = `Bs. ${totalEfectivo}`;
            totalQRElement.textContent = `Bs. ${totalQR}`;
            totalGeneralElement.textContent = `Bs. ${totalEfectivo + totalQR}`;
        }
        
        // Función para descargar los registros como CSV
        downloadBtn.addEventListener('click', function() {
            if (records.length === 0) {
                alert('No hay registros para descargar');
                return;
            }
            
            // Crear contenido CSV
            let csvContent = "Fecha,Hora,N° Registro,Método Pago,Monto (Bs.),Operación,Total Efectivo,Total QR\n";
            
            records.forEach(record => {
                csvContent += `"${record.date}","${record.time}",${record.counter},"${record.paymentMethod}",${record.monto},${record.operation},${record.totalEfectivo},${record.totalQR}\n`;
            });
            
            // Crear archivo y descargar
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `registros_futbolin_${currentDate}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Función para cerrar el día
        closeDayBtn.addEventListener('click', function() {
            const confirmClose = confirm('¿Está seguro que desea cerrar el día? Esto reiniciará todos los registros.');
            if (!confirmClose) return;
            
            // Guardar un registro de cierre en GitHub
            saveCloseDayToGithub();
            
            // Reiniciar variables
            counter = 1;
            records = [];
            totalEfectivo = 0;
            totalQR = 0;
            currentDate = new Date().toISOString().slice(0, 10);
            
            // Crear un nuevo archivo para el siguiente día
            createNewDayFile();
            
            // Actualizar la interfaz
            counterElement.textContent = counter;
            recordsBody.innerHTML = '';
            updateTotals();
            changeLastBtn.disabled = true;
            
            alert('Día cerrado correctamente. Todos los registros han sido reiniciados.');
        });
        
        // Funciones para GitHub
        
        // Guardar un nuevo registro en GitHub
        async function saveToGithub(record) {
            if (!isGithubConfigValid()) return;
            
            try {
                // Obtener el archivo actual
                const fileResponse = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.filepath}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!fileResponse.ok) {
                    showGithubStatus('Error al acceder al archivo', false);
                    return;
                }
                
                const fileData = await fileResponse.json();
                const currentContent = decodeURIComponent(escape(atob(fileData.content)));
                
                // Crear la nueva línea para el registro
                const newLine = `"${record.date}","${record.time}",${record.counter},"${record.paymentMethod}",${record.monto},${record.operation},${record.totalEfectivo},${record.totalQR}\n`;
                
                // Combinar el contenido existente con la nueva línea
                const updatedContent = currentContent + newLine;
                
                // Actualizar el archivo en GitHub
                const updateResponse = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.filepath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Nuevo registro #${record.counter} - ${record.date} ${record.time}`,
                        content: btoa(unescape(encodeURIComponent(updatedContent))),
                        sha: fileData.sha
                    })
                });
                
                if (updateResponse.ok) {
                    showGithubStatus('Registro guardado en GitHub', true);
                } else {
                    const errorData = await updateResponse.json();
                    showGithubStatus(`Error al guardar: ${errorData.message}`, false);
                }
            } catch (error) {
                showGithubStatus('Error al guardar: ' + error.message, false);
            }
        }
        
        // Actualizar el último registro en GitHub
        async function updateLastRecordInGithub() {
            if (!isGithubConfigValid() || records.length === 0) return;
            
            try {
                // Obtener todos los registros y actualizar el archivo completo
                let csvContent = "Fecha,Hora,N° Registro,Método Pago,Monto (Bs.),Operación,Total Efectivo,Total QR\n";
                
                records.forEach(record => {
                    csvContent += `"${record.date}","${record.time}",${record.counter},"${record.paymentMethod}",${record.monto},${record.operation},${record.totalEfectivo},${record.totalQR}\n`;
                });
                
                // Obtener el archivo actual para su SHA
                const fileResponse = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.filepath}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!fileResponse.ok) {
                    showGithubStatus('Error al acceder al archivo', false);
                    return;
                }
                
                const fileData = await fileResponse.json();
                
                // Actualizar el archivo en GitHub
                const updateResponse = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.filepath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Modificación del último registro - ${new Date().toLocaleString()}`,
                        content: btoa(unescape(encodeURIComponent(csvContent))),
                        sha: fileData.sha
                    })
                });
                
                if (updateResponse.ok) {
                    showGithubStatus('Registro actualizado en GitHub', true);
                } else {
                    const errorData = await updateResponse.json();
                    showGithubStatus(`Error al actualizar: ${errorData.message}`, false);
                }
            } catch (error) {
                showGithubStatus('Error al actualizar: ' + error.message, false);
            }
        }
        
        // Guardar registro de cierre de día en GitHub
        async function saveCloseDayToGithub() {
            if (!isGithubConfigValid()) return;
            
            try {
                // Obtener el archivo actual
                const fileResponse = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.filepath}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!fileResponse.ok) {
                    showGithubStatus('Error al acceder al archivo', false);
                    return;
                }
                
                const fileData = await fileResponse.json();
                const currentContent = decodeURIComponent(escape(atob(fileData.content)));
                
                // Añadir línea de cierre de día
                const now = new Date();
                const closingLine = `\n--- CIERRE DE DÍA ${now.toLocaleDateString()} ${now.toLocaleTimeString()} - Total Efectivo: Bs. ${totalEfectivo} - Total QR: Bs. ${totalQR} - Total General: Bs. ${totalEfectivo + totalQR} ---\n`;
                
                const updatedContent = currentContent + closingLine;
                
                // Actualizar el archivo en GitHub
                const updateResponse = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.filepath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Cierre de día - ${now.toLocaleDateString()}`,
                        content: btoa(unescape(encodeURIComponent(updatedContent))),
                        sha: fileData.sha
                    })
                });
                
                if (updateResponse.ok) {
                    showGithubStatus('Cierre de día guardado en GitHub', true);
                } else {
                    const errorData = await updateResponse.json();
                    showGithubStatus(`Error al guardar cierre: ${errorData.message}`, false);
                }
            } catch (error) {
                showGithubStatus('Error al guardar cierre: ' + error.message, false);
            }
        }
        
        // Crear un nuevo archivo para el siguiente día (después del cierre)
        async function createNewDayFile() {
            if (!isGithubConfigValid()) return;
            
            try {
                // Crear un nuevo nombre de archivo con la fecha del siguiente día
                const nextDay = new Date();
                nextDay.setDate(nextDay.getDate() + 1);
                const nextDayString = nextDay.toISOString().slice(0,